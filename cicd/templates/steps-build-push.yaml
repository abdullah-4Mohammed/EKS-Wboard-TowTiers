steps:
- task: Docker@2
  displayName: Build and push an image to container registry
  inputs:
    containerRegistry: $(dockerRegistryServiceConnection)
    repository: $(imageRepository)/wbapp
    command: build 
    dockerfile: $(dockerFile)
    tags: |
      $(Build.BuildId)
      
    
# - task: ECRPushImage@1
#   displayName: Push to ECR
#   inputs:
#     awsCredentials: $(awsConnection)
#     regionName: $(region)
#     imageSource: 'imagenamewithtag'
#     sourceImageName: '390402557273.dkr.ecr.eu-west-2.amazonaws.com/$(imageRepository)/wbapp'
#     sourceImageTags: '$(Build.BuildId)'
    
#     repositoryName: $(imageRepository)
#     imageTag: |
#       $(Build.BuildId)
#       latest
     
- task: AWSCLI@1
  displayName: 'Get ECR login password'
  inputs:
    awsCredentials: '$(awsConnection)'
    regionName: '$(region)'
    awsCommand: 'ecr'
    awsSubCommand: 'get-login-password'
    awsArguments: '--region $(region)'
    scriptLocation: 'inline'
    inlineScript: |
      PASSWORD=$(aws ecr get-login-password --region $(region))
      echo $PASSWORD | docker login --username AWS --password-stdin $(awsAccountId).dkr.ecr.$(region).amazonaws.com

- script: |
    docker tag $(imageRepository)/wbapp:$(Build.BuildId) $(awsAccountId).dkr.ecr.$(region).amazonaws.com/$(imageRepository)/wbapp:$(Build.BuildId)
    docker push $(awsAccountId).dkr.ecr.$(region).amazonaws.com/$(imageRepository)/wbapp:$(Build.BuildId)
  displayName: 'Push image to ECR'

- script: |
    docker tag $(imageRepository)/wbapp:$(Build.BuildId) $(awsAccountId).dkr.ecr.$(region).amazonaws.com/$(imageRepository)/wbapp:latest
    docker push $(awsAccountId).dkr.ecr.$(region).amazonaws.com/$(imageRepository)/wbapp:latest
  displayName: 'Push image to ECR'


